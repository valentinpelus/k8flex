---
# Alertmanager configuration to send webhooks to k8flex-agent
# Reference: https://prometheus.io/docs/alerting/latest/configuration/#webhook_config
# 
# Add this receiver to your alertmanager.yaml:
#
# receivers:
#   - name: 'k8flex-ai-debug'
#     webhook_configs:
#       - url: 'http://k8flex-agent.k8flex.svc.cluster.local:8080/webhook'
#         send_resolved: false
#         http_config:
#           follow_redirects: true
#
# And add a route:
#
# routes:
#   - match:
#       severity: critical
#     receiver: 'k8flex-ai-debug'
#     continue: true  # Allow other receivers to also handle this alert

apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-k8flex-config
  namespace: monitoring
data:
  alertmanager-webhook.yaml: |
    receivers:
      - name: 'k8flex-ai-debug'
        webhook_configs:
          - url: 'http://k8flex-agent.k8flex.svc.cluster.local:8080/webhook'
            send_resolved: false
            http_config:
              follow_redirects: true
    
    route:
      receiver: 'default-receiver'
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      routes:
        # Send all critical alerts to AI debug agent
        - match:
            severity: critical
          receiver: 'k8flex-ai-debug'
          continue: true  # Continue to other receivers
        
        # Send all warning alerts that mention pods to AI debug agent
        - match_re:
            alertname: '.*Pod.*|.*Container.*'
          receiver: 'k8flex-ai-debug'
          continue: true
