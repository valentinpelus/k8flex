---
apiVersion: v1
kind: Namespace
metadata:
  name: k8flex
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: k8flex-agent
  namespace: k8flex
---
# ClusterRole with permissions to read Kubernetes resources for debugging
# Reference: https://kubernetes.io/docs/reference/access-authn-authz/rbac/
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: k8flex-agent
rules:
  # Pod operations
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
  # Service operations
  - apiGroups: [""]
    resources: ["services", "endpoints"]
    verbs: ["get", "list", "watch"]
  # Events
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "watch"]
  # Network policies
  - apiGroups: ["networking.k8s.io"]
    resources: ["networkpolicies"]
    verbs: ["get", "list", "watch"]
  # Nodes (for debugging)
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list"]
  # ConfigMaps and Secrets metadata (not data)
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list"]
  # Deployments, StatefulSets, DaemonSets
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets", "daemonsets", "replicasets"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: k8flex-agent
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: k8flex-agent
subjects:
  - kind: ServiceAccount
    name: k8flex-agent
    namespace: k8flex
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: k8flex-config
  namespace: k8flex
data:
  OLLAMA_URL: "http://ollama.ollama.svc.cluster.local:11434"
  OLLAMA_MODEL: "llama3"
  PORT: "8080"
  # SLACK_WEBHOOK_URL: ""  # Set this via Secret or uncomment and add your webhook URL
---
# Optional: Use a Secret for Slack credentials (recommended)
apiVersion: v1
kind: Secret
metadata:
  name: k8flex-secrets
  namespace: k8flex
type: Opaque
stringData:
  # For threading support, use Bot token (recommended):
  SLACK_BOT_TOKEN: ""     # xoxb-your-bot-token (enables threading)
  SLACK_CHANNEL_ID: ""    # C01234567890 (channel ID)
  # OR use webhook (no threading):
  SLACK_WEBHOOK_URL: "https://hooks.slack.com/services/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"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: k8flex-agent
  namespace: k8flex
  labels:
    app: k8flex-agent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: k8flex-agent
  template:
    metadata:
      labels:
        app: k8flex-agent
    spec:
      serviceAccountName: k8flex-agent
      containers:
        - name: k8flex-agent
          image: k8flex-agent:latest
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          envFrom:
            - configMapRef:
                name: k8flex-config
            - secretRef:
                name: k8flex-secrets
                optional: true
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
---
apiVersion: v1
kind: Service
metadata:
  name: k8flex-agent
  namespace: k8flex
  labels:
    app: k8flex-agent
spec:
  type: ClusterIP
  ports:
    - port: 8080
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app: k8flex-agent
